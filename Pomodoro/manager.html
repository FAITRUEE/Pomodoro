<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì í˜ì´ì§€</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">Admin Panel</a>
    <ul class="navbar-nav ms-auto">
      <li class="nav-item">
        <a class="nav-link text-white" href="main.html">â ì‚¬ìš©ì í™”ë©´</a>
      </li>
      <li class="nav-item">
        <a class="nav-link text-white" href="login.html">ğŸšª ë¡œê·¸ì•„ì›ƒ</a>
      </li>
    </ul>
  </div>
</nav>

<div class="container">
  <h2 class="mb-4">ğŸ‘¥ ì‚¬ìš©ì ëª©ë¡</h2>
  <table class="table table-bordered bg-white text-center align-middle">
    <thead class="table-dark">
    <tr>
      <th>ì´ë¦„</th>
      <th>ì´ë©”ì¼</th>
      <th>ê¶Œí•œ</th>
      <th>ìµœê·¼ ë©”ëª¨</th>
      <th>ê´€ë¦¬</th>
    </tr>
    </thead>
    <tbody id="userTableBody"></tbody>
  </table>

  <h2 class="mt-5">âš™ ì‹œìŠ¤í…œ ê¸°ë³¸ ì„¤ì •</h2>
  <form>
    <div class="mb-3">
      <label for="defaultFocus" class="form-label">ê¸°ë³¸ ì§‘ì¤‘ ì‹œê°„ (ë¶„)</label>
      <input type="number" class="form-control" id="defaultFocus" value="25">
      <div class="form-text">â€» ì´ ì„¤ì •ì€ ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ê³µí†µìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.</div>
    </div>
    <button type="button" class="btn btn-success" onclick="saveSettings()">ì €ì¥</button>
  </form>
</div>

<script>
  function getLatestNoteByEmail(email) {
    const notes = [];

    Object.keys(localStorage).forEach(key => {
      if (key.startsWith(`session_${email}_`)) {
        try {
          const session = JSON.parse(localStorage.getItem(key));
          if (session && session.note) {
            notes.push({ note: session.note, date: new Date(session.completedAt) });
          }
        } catch {}
      }
    });

    notes.sort((a, b) => b.date - a.date);
    return notes.length > 0 ? notes[0].note : "ì‘ì„±ëœ ë©”ëª¨ ì—†ìŒ";
  }

  function loadUsers() {
    const tbody = document.getElementById("userTableBody");
    tbody.innerHTML = "";

    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);

      // ì‚¬ìš©ì ì •ë³´ ì™¸ì˜ ë°ì´í„° ê±´ë„ˆë›°ê¸°
      if (
              key.startsWith("session_") ||
              key.startsWith("goal_") ||
              key.startsWith("system_") ||
              key.startsWith("user_points_") ||
              key.startsWith("lastActiveDate_") ||
              key.startsWith("timer_") ||
              key === "loggedInUser"
      ) continue;

      try {
        const user = JSON.parse(localStorage.getItem(key));
        if (user && user.email && user.password) {
          const note = getLatestNoteByEmail(user.email);
          const row = `
            <tr>
              <td>${user.name || "-"}</td>
              <td>${user.email}</td>
              <td>${user.role || "user"}</td>
              <td>${note}</td>
              <td><button class="btn btn-sm btn-danger" onclick="deleteUser('${user.email}')">ì‚­ì œ</button></td>
            </tr>
          `;
          tbody.innerHTML += row;
        }
      } catch (e) {
        continue;
      }
    }
  }

  function deleteUser(email) {
    if (confirm(`ì •ë§ë¡œ ${email} ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      localStorage.removeItem(email);

      // í•´ë‹¹ ì‚¬ìš©ìì˜ ê´€ë ¨ í‚¤ë„ ì‚­ì œ (ì˜ˆ: session_, goal_, points_ ë“±)
      Object.keys(localStorage).forEach(key => {
        if (key.includes(email)) {
          localStorage.removeItem(key);
        }
      });

      alert("âœ… ì‚¬ìš©ì ì •ë³´ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
      loadUsers();
    }
  }

  function saveSettings() {
    const time = document.getElementById("defaultFocus").value;
    localStorage.setItem("system_focus_time", time);
    alert("âœ… ì‹œìŠ¤í…œ ê¸°ë³¸ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
  }

  window.onload = () => {
    loadUsers();
    const saved = localStorage.getItem("system_focus_time");
    if (saved) {
      document.getElementById("defaultFocus").value = saved;
    }
  };
</script>

</body>
</html>
